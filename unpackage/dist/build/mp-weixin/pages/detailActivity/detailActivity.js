(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/detailActivity/detailActivity"],{"0388":function(t,e,a){},"269a":function(t,e,a){"use strict";a.d(e,"b",(function(){return n})),a.d(e,"c",(function(){return i})),a.d(e,"a",(function(){}));var n=function(){var t=this.$createElement,e=(this._self._c,this.hasJoined&&this.participantsInfo.length);this.$mp.data=Object.assign({},{$root:{g0:e}})},i=[]},"5a4c":function(t,e,a){"use strict";var n=a("0388"),i=a.n(n);i.a},7459:function(t,e,a){"use strict";(function(t,n){var i=a("47a9");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var r=i(a("7eb4")),c=i(a("ee10")),o=i(a("7ca3"));function s(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,n)}return a}function u(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?s(Object(a),!0).forEach((function(e){(0,o.default)(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}var l={data:function(){return{activityId:"",activityData:{id:"",name:"",area:"",location:"",date:"",timeSlot:"",totalPeople:0,joinedPeople:0,contact:"",description:"",creatorName:""},participantsInfo:[]}},computed:{fullAddress:function(){var t=this.activityData.area||"",e=this.activityData.location||"";if(t||e){var a=e?" "+e:"";return"广东省广州市".concat(t).concat(a)}return"未设置"},isOwner:function(){try{var e=t.getStorageSync("username")||"",a=this.activityData.creatorName||"";return e&&a&&String(e)===String(a)}catch(n){return!1}},hasJoined:function(){try{var e=t.getStorageSync("username")||"",a=Array.isArray(this.activityData.participants)?this.activityData.participants:[];return!(!e||!a.some((function(t){return String(t&&t.username)===String(e)})))}catch(n){return!1}}},onLoad:function(e){var a=this;if(!e||!e.id){console.error("活动标识缺失（需要 id）","参数:",e),t.showModal({title:"错误",content:"活动标识缺失（需要 id）",showCancel:!1,complete:function(){return t.navigateBack()}})}try{var n=e.id||"";this.activityId=decodeURIComponent(String(n)).trim()}catch(c){this.activityId=(e.id||"").trim()}console.log("加载活动详情，参数:",{id:this.activityId});try{var i=String(this.activityId||"");t.setStorageSync("currentActivityId",i),t.setStorageSync("activityid",i)}catch(c){}if(!this.activityId){console.error("活动标识无效"),t.showModal({title:"错误",content:"活动标识无效",showCancel:!1,complete:function(){return t.navigateBack()}})}try{var r=this.getOpenerEventChannel&&this.getOpenerEventChannel();r&&r.on&&r.on("activityPrefill",(function(t){var e=t.activity;console.log("收到预填充活动数据:",e),e&&a.prefillActivity(e)}))}catch(o){console.warn("获取 eventChannel 失败（可能是直达打开详情页）:",o)}this.loadActivityDetail()},methods:{prefillActivity:function(e){var a={id:e.id||e._id||"",name:e.name||"未命名活动",area:e.area||"",location:e.location||"",date:e.date||"未设置日期",timeSlot:e.timeSlot||"未设置时间",totalPeople:e.totalPeople||0,joinedPeople:e.joinedPeople||0,participants:Array.isArray(e.participants)?e.participants:[],contact:e.contact||"未提供",description:e.description||"暂无详细说明",creatorName:e.creatorName||e.creator||""};this.activityData=u(u({},this.activityData),a);try{if(a.id){var n=String(a.id);t.setStorageSync("currentActivityId",n),t.setStorageSync("activityid",n)}}catch(i){}},loadActivityDetail:function(){var e=this;return(0,c.default)(r.default.mark((function a(){var i;return r.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(e.activityId){a.next=3;break}return console.error("活动标识为空"),a.abrupt("return");case 3:return a.prev=3,t.showLoading({title:"加载中...",mask:!0}),console.log("正在请求活动详情，参数:",{id:e.activityId}),a.next=8,n.callFunction({name:"getActivityDetail",data:{id:e.activityId},timeout:1e4});case 8:if(i=a.sent,console.log("获取到活动详情响应:",i),0!==i.result.code){a.next=18;break}if(i.result.data){a.next=13;break}throw new Error("返回的活动数据为空");case 13:e.prefillActivity(i.result.data),console.log("活动数据加载成功:",e.activityData),e.hasJoined?e.loadParticipantsInfo():e.participantsInfo=[],a.next=19;break;case 18:throw new Error(i.result.message||"获取活动详情失败");case 19:a.next=25;break;case 21:a.prev=21,a.t0=a["catch"](3),console.error("加载活动详情失败:",{message:a.t0.message,stack:a.t0.stack,activityId:e.activityId}),t.showModal({title:"加载失败",content:"无法加载活动详情: ".concat(a.t0.message||"未知错误"),showCancel:!1,confirmText:"返回",success:function(){t.navigateBack()}});case 25:return a.prev=25,t.hideLoading(),a.finish(25);case 28:case"end":return a.stop()}}),a,null,[[3,21,25,28]])})))()},handleJoin:function(){var e=this;return(0,c.default)(r.default.mark((function a(){var i,o,s,u,l,d,f,v,p,h,y;return r.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:i="";try{i=t.getStorageSync("activityid")||""}catch(g){}if(!i)try{i=t.getStorageSync("currentActivityId")||""}catch(g){}if(i||(i=e.activityData.id||e.activityId),i){a.next=6;break}return a.abrupt("return");case 6:o="",s="/static/icons/my.png";try{o=t.getStorageSync("username")||"",u=t.getStorageSync("userInfo")||{},!o&&u&&u.username&&(o=String(u.username))}catch(g){}if(o){a.next=13;break}return t.showToast({title:"请先登录后再报名",icon:"none"}),setTimeout((function(){return t.navigateTo({url:"/pages/login/login"})}),600),a.abrupt("return");case 13:if(a.prev=13,l=Array.isArray(e.activityData.participants)?e.activityData.participants:[],d=l.some((function(t){return String(t&&t.username)===String(o)})),!d){a.next=19;break}return t.showModal({title:"退出活动",content:"确定要退出该活动吗？",success:function(){var a=(0,c.default)(r.default.mark((function a(c){var s,u,d;return r.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(c.confirm){a.next=2;break}return a.abrupt("return");case 2:return a.prev=2,t.showLoading({title:"退出中...",mask:!0}),a.next=6,n.callFunction({name:"leaveActivity",data:{id:i,username:o},timeout:15e3});case 6:s=a.sent,u=s&&s.result||{},0===u.code?(d=Math.max(0,Number(e.activityData.joinedPeople||0)-1),e.activityData.joinedPeople=d,e.activityData.participants=l.filter((function(t){return String(t&&t.username)!==String(o)})),e.activityData.updatedAt=Date.now(),t.showToast({title:"已退出活动",icon:"success"}),e.participantsInfo=[]):t.showToast({title:u.message||"退出失败，请稍后重试",icon:"none"}),a.next=15;break;case 11:a.prev=11,a.t0=a["catch"](2),console.error("退出失败:",a.t0),t.showToast({title:a.t0.message||"退出失败，请检查网络",icon:"none"});case 15:return a.prev=15,t.hideLoading(),a.finish(15);case 18:case"end":return a.stop()}}),a,null,[[2,11,15,18]])})));return function(t){return a.apply(this,arguments)}}()}),a.abrupt("return");case 19:a.next=23;break;case 21:a.prev=21,a.t0=a["catch"](13);case 23:return a.prev=23,t.showLoading({title:"报名中...",mask:!0}),f=i,a.next=28,n.callFunction({name:"joinActivity",data:{id:f,username:o,avatar:s},timeout:15e3});case 28:v=a.sent,p=v&&v.result?v.result:{},0===p.code?(h=Number(e.activityData.joinedPeople||0)+1,e.activityData.joinedPeople=h,Array.isArray(e.activityData.participants)?e.activityData.participants.push({username:o,avatar:s,joinTime:Date.now()}):e.activityData.participants=[{username:o,avatar:s,joinTime:Date.now()}],e.activityData.updatedAt=Date.now(),t.showToast({title:"报名成功",icon:"success"}),e.loadParticipantsInfo()):(y=p.message||"报名失败，请稍后重试",t.showToast({title:y,icon:"none"})),a.next=37;break;case 33:a.prev=33,a.t1=a["catch"](23),console.error("报名失败:",a.t1),t.showToast({title:a.t1.message||"报名失败，请检查网络",icon:"none"});case 37:return a.prev=37,t.hideLoading(),a.finish(37);case 40:case"end":return a.stop()}}),a,null,[[13,21],[23,33,37,40]])})))()},goEditActivity:function(){var e=this,a=this.activityData.id||this.activityId;a&&t.navigateTo({url:"/pages/editActivity/editActivity?id=".concat(a),success:function(t){t.eventChannel&&t.eventChannel.emit("activityPrefill",{activity:e.activityData})}})},confirmDelete:function(){var e=this;t.showModal({title:"确认删除",content:"删除后不可恢复，确认删除该活动吗？",success:function(){var t=(0,c.default)(r.default.mark((function t(a){return r.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!a.confirm){t.next=3;break}return t.next=3,e.deleteActivity();case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()})},deleteActivity:function(){var e=this;return(0,c.default)(r.default.mark((function a(){var i,c;return r.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(e.activityId){a.next=2;break}return a.abrupt("return");case 2:return i=t.getStorageSync("username")||"",a.prev=3,t.showLoading({title:"删除中...",mask:!0}),a.next=7,n.callFunction({name:"deleteActivity",data:{id:e.activityId,username:i}});case 7:if(c=a.sent,!c.result||0!==c.result.code){a.next=13;break}t.showToast({title:"删除成功",icon:"success"}),setTimeout((function(){t.switchTab({url:"/pages/index/index",fail:function(){return t.reLaunch({url:"/pages/index/index"})}})}),800),a.next=14;break;case 13:throw new Error(c.result&&c.result.message||"删除失败");case 14:a.next=19;break;case 16:a.prev=16,a.t0=a["catch"](3),t.showToast({title:a.t0.message||"删除失败",icon:"none"});case 19:return a.prev=19,t.hideLoading(),a.finish(19);case 22:case"end":return a.stop()}}),a,null,[[3,16,19,22]])})))()},goUserProfileTap:function(t){try{var e=t&&t.currentTarget&&t.currentTarget.dataset&&t.currentTarget.dataset.username;e&&this.goUserProfile(String(e))}catch(a){}},goUserProfile:function(e){if(e){var a="/pages/userInfo/userInfo?username=".concat(encodeURIComponent(String(e)));t.navigateTo({url:a})}},loadParticipantsInfo:function(){var t=this;return(0,c.default)(r.default.mark((function e(){var a,i,c;return r.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(e.prev=0,a=t.activityData.id||t.activityId,a){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,n.callFunction({name:"getActivityParticipants",data:{id:a},timeout:1e4});case 6:i=e.sent,c=i&&i.result||{},0===c.code&&Array.isArray(c.data)?t.participantsInfo=c.data:t.participantsInfo=[],e.next=15;break;case 11:e.prev=11,e.t0=e["catch"](0),console.error("加载参与者信息失败:",e.t0),t.participantsInfo=[];case 15:case"end":return e.stop()}}),e,null,[[0,11]])})))()}}};e.default=l}).call(this,a("df3c")["default"],a("861b")["uniCloud"])},"9f82":function(t,e,a){"use strict";a.r(e);var n=a("7459"),i=a.n(n);for(var r in n)["default"].indexOf(r)<0&&function(t){a.d(e,t,(function(){return n[t]}))}(r);e["default"]=i.a},f2ec:function(t,e,a){"use strict";a.r(e);var n=a("269a"),i=a("9f82");for(var r in i)["default"].indexOf(r)<0&&function(t){a.d(e,t,(function(){return i[t]}))}(r);a("5a4c");var c=a("828b"),o=Object(c["a"])(i["default"],n["b"],n["c"],!1,null,null,null,!1,n["a"],void 0);e["default"]=o.exports},f31c:function(t,e,a){"use strict";(function(t,e){var n=a("47a9");a("d909"),a("861b");n(a("3240"));var i=n(a("f2ec"));t.__webpack_require_UNI_MP_PLUGIN__=a,e(i.default)}).call(this,a("3223")["default"],a("df3c")["createPage"])}},[["f31c","common/runtime","common/vendor"]]]);